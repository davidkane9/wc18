---
title: "Player Data for the 2018 FIFA World Cup"
author: "David Kane"
date: June 14, 2018
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringr)
library(lubridate)
```

The World Cup starts today! The purpose of this R Views is to gather and explore data for the 736 players from the 32 teams at the 2018 FIFA World Cup. The tournament runs from June 14 through July 15 and is probably the most popular sporting event in the world.

## Download Player Data

FIFA has made several official player lists available, (in)conveniently changing the format each time. For this exercise, I use the one from early June.[^1] The [tabulizer package](https://CRAN.R-project.org/package=tabulizer) makes extracting information from tables included in a PDF document relatively easy. 

```{r, warning=FALSE}
# Note that I set warnings to FALSE because of some annoying (and intermittent)
# issues with RJavaTools.

library(tabulizer)
url <- "https://github.com/davidkane9/wc18/raw/master/fifa_player_list_1.pdf"
out <- extract_tables(url, output = "data.frame")
```

We now have a 32 element list, each item a dataframe of information about the 23 players on each team. Let's combine this information into a single tidy tibble.

```{r}
# Note how bind_rows() makes it very easy to combine a list of compatible
# dataframes.

pdf_data <- bind_rows(out) %>% 
  as_tibble() %>% 
  
  # Make the variable names more tidy-like.
  
  rename(team = Team,
         number = X.,
         position = Pos.,
         name = FIFA.Popular.Name,
         birth_date = Birth.Date,
         shirt_name = Shirt.Name,
         club = Club,
         height = Height,
         weight = Weight) %>% 
  
  # Country names are contentious issues. I modify two names because I will
  # later need to merge this tibble with data from Wikipedia, which uses
  # different names.
  
  mutate(team = case_when(
         team == "Korea Republic" ~ "South Korea",
         team == "IR Iran" ~ "Iran",
         TRUE ~ team)) %>% 
  
  # league and club should be separate variables. We also want birth_date to be
  # a date and to have amn age variable already calculated.
  
  mutate(birth_date = dmy(birth_date),
         league = str_sub(club, -4, -2),
         club = str_sub(club, end = -7),
         age = interval(birth_date, "2018-06-14") / years(1))
```

```{r}
set.seed(9)
pdf_data %>% sample_n(10)
```


Perform some error checking.

```{r}
stopifnot(length(unique(pdf_data$team)) == 32)      # There are 32 teams.
stopifnot(all(range(table(pdf_data$team)) == 23))   # Each team has 23 players.
stopifnot(pdf_data %>% 
            filter(position == "GK") %>% 
            group_by(team) %>% 
            tally() %>% 
            filter(n != 3) %>% 
            nrow() == 0)                     # All teams have 3 goal keepers.
stopifnot(all(pdf_data$position %in% 
                c("GK", "DF", "MF", "FW")))  # All players assigned to 1 of 4 positions.

```

Wikipedia includes other player information which might be interesting, especially the number of caps for each player. A "cap" is an appearence in a game for the national team. The rvest package makes scraping data from Wikipedia fairly easy.

```{r}
library(rvest)
html <- read_html("https://en.wikipedia.org/wiki/2018_FIFA_World_Cup_squads")

# Once we have read in all the html, we need to identify the location of the
# data we want. The rvest vignette provides guidance, but the key trick is the
# use of SelectorGadget to find the correct CSS node.

# First, we need the country and the shirt number of each player so that we can
# merge this data with that from the PDF.

country <- html_nodes(html, ".mw-headline") %>% 
  html_text() %>%
  as_tibble() %>% 
  filter(! str_detect(value, "Group")) %>% 
  slice(1:32)

number <- html_nodes(html, ".plainrowheaders td:nth-child(1)") %>% 
  html_text()

# We don't need the name of each player but I like to grab it, both because I
# prefer the Wikipedia formatting and to use this as a cross-check on the
# accuracy of our country/number merge.

name <- html_nodes(html, "th a") %>% 
  html_text() %>% 
  as_tibble() %>% 
  filter(! str_detect(value, "^captain$")) %>% 
  slice(1:736)

# cap is the variable we care about, but Wikipedia page also includes the number
# of goals that each player has scored for the national team. Try adding that
# information on your own.

caps <- html_nodes(html, ".plainrowheaders td:nth-child(5)") %>% 
  html_text()

# Create a tibble. Note that we are relying on all the vectors being in the
# correct order.

wiki_data <- tibble(
  number = as.numeric(number),
  name = name$value,
  team = rep(country$value, each = 23),
  caps = as.numeric(caps))

# I prefer the name from Wikipedia. Exercise for the reader: How might we use
# name (from Wikipedia) and shirt_name (from the PDF) to confirm that we have
# lined up the data correctly?
  
x <- left_join(select(pdf_data, -name), wiki_data, by = c("team", "number"))
```

For the entire sample of `r nrow(x)` players, there is a clear birth month effect, visible both when looking at calendar months and when aggregating to calendar quarters.

```{r}
x  %>% ggplot(aes(x = month(birth_date, label = TRUE))) + geom_histogram(stat = "count")
```

```{r}
x  %>% ggplot(aes(x = quarter(birth_date))) + geom_histogram(stat = "count") 
```

Strangely, the effect is only true for players who will be 25 and over at the start of the World Cup, about 75% of the sample.

```{r}
x %>% ggplot(aes(x = month(birth_date, label = TRUE))) + geom_histogram(stat = "count") + facet_wrap(~ cut(age, breaks = c(0, 24, 50)))
```

```{r}
x %>% ggplot(aes(x = quarter(birth_date))) + geom_histogram(stat = "count") + facet_wrap(~ cut(age, breaks = c(0, 24, 50)))
```
Why would that be true? Maybe something to do with players being assigned to the U-23 team? You can see something weird going on for age 24 especially:

```{r}
plot(table(floor(x$age)))
```

Note how there are way fewer 24 year-olds than we might expect, given the big jump from 23 to 25? 


Another thing of note is that, when running a chi-squared test --- and adding ages from low to high --- you have to get to 28 before it pops significant for birth quarter and to 31 for birth month. Not sure I am doing this right though . . .

[^1]: The other (later) version of the official PDF is [here](https://github.com/davidkane9/wc18/raw/master/fifa_player_list_1.pdf). Strangely, the weight variable has been dropped.




